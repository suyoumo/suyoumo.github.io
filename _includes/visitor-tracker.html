<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
(function() {
  var SUPABASE_URL = '{{ site.supabase.url }}';
  var SUPABASE_KEY = '{{ site.supabase.anon_key }}';
  if (!SUPABASE_URL || SUPABASE_URL === 'YOUR_SUPABASE_URL') return;

  var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  var path = window.location.pathname;
  var vid = localStorage.getItem('_vid');
  if (!vid) {
    vid = crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2) + Date.now().toString(36);
    localStorage.setItem('_vid', vid);
  }

  // Record visit (ignore duplicate)
  sb.from('page_views').upsert({ page_path: path, visitor_id: vid }, { onConflict: 'page_path,visitor_id' }).then(function() {
    // Count unique visitors for this page
    sb.rpc('count_unique_visitors', { target_path: path }).then(function(res) {
      var el = document.getElementById('unique_visitor_count');
      if (el && res.data !== null) el.textContent = res.data;
    });
  });
})();
</script>
